# 用户生命周期测试文档

## 概述

本文档描述了智能大数据平台的用户生命周期端到端测试用例设计与实现。测试基于五种用户角色的完整生命周期，确保系统功能覆盖全面。

## 目录结构

```
tests/
├── conftest.py                           # 共享 fixtures 配置
├── fixtures/
│   ├── __init__.py
│   └── test_users.py                     # 用户角色 fixtures
└── e2e/
    ├── __init__.py
    ├── test_admin_lifecycle.py           # 超级管理员生命周期测试
    ├── test_engineer_lifecycle.py        # 数据工程师生命周期测试
    ├── test_analyst_lifecycle.py         # 数据分析师生命周期测试
    ├── test_asset_admin_lifecycle.py     # 数据资产管理员测试
    └── test_security_admin_lifecycle.py  # 安全管理员生命周期测试
```

## 用户角色定义

### 角色权限表

| 角色 | 权限级别 | 核心职责 |
|------|---------|---------|
| **超级管理员** | is_superuser=True | 用户管理、角色管理、审计日志查看 |
| **数据工程师** | 数据源权限 | 数据源管理、ETL管道、数据采集 |
| **数据分析师** | 分析权限 | 数据查询、AI分析、资产搜索 |
| **数据资产管理员** | 资产权限 | 资产目录、认证、血缘管理 |
| **安全管理员** | 安全权限 | 告警规则、敏感数据检测、告警处理 |

### 权限定义

```python
ROLE_PERMISSIONS = {
    "superuser": [
        "users:read", "users:write",
        "roles:read", "roles:write",
        "audit:read"
    ],
    "data_engineer": [
        "sources:read", "sources:write",
        "metadata:read", "metadata:write",
        "collect:read", "collect:write",
        "etl:read", "etl:write"
    ],
    "data_analyst": [
        "analysis:read", "analysis:write",
        "assets:read", "assets:search",
        "lineage:read"
    ],
    "asset_admin": [
        "assets:read", "assets:write", "assets:certify",
        "lineage:read", "lineage:write"
    ],
    "security_admin": [
        "security:read", "security:write",
        "alerts:read", "alerts:write", "alerts:manage"
    ]
}
```

## 测试用例设计

### 1. 超级管理员生命周期

**文件**: `tests/e2e/test_admin_lifecycle.py`

**生命周期阶段**: 注册 → 登录 → 用户管理 → 角色管理 → 审计

| 测试类 | 测试用例 | 描述 |
|-------|---------|------|
| TestAdminRegistration | test_admin_register_success | 成功注册新管理员 |
| | test_admin_register_duplicate_email | 重复邮箱注册失败 |
| | test_admin_register_invalid_email | 无效邮箱格式验证 |
| TestAdminLogin | test_admin_login_missing_credentials | 缺少凭证登录失败 |
| | test_admin_login_invalid_password | 无效密码登录失败 |
| TestAdminGetCurrentUser | test_get_me_unauthorized | 未认证获取用户失败 |
| | test_get_me_success | 认证后获取用户成功 |
| TestAdminUserManagement | test_list_users_unauthorized | 未认证列出用户失败 |
| | test_list_users_non_superuser | 非管理员列出用户失败 |
| | test_list_users_as_superuser | 管理员列出用户成功 |
| TestAdminRoleManagement | test_create_role_unauthorized | 未认证创建角色失败 |
| | test_create_role_non_superuser | 非管理员创建角色失败 |
| | test_create_role_as_superuser | 管理员创建角色成功 |
| | test_list_roles | 列出所有角色 |
| TestAdminAuditLogs | test_view_audit_logs_unauthorized | 未认证查看审计日志失败 |
| | test_view_audit_logs_non_superuser | 非管理员查看审计日志失败 |
| | test_view_audit_logs_as_superuser | 管理员查看审计日志成功 |
| | test_view_audit_logs_with_filters | 带过滤条件查看审计日志 |
| TestAdminLifecycleIntegration | test_admin_full_lifecycle | 完整管理员生命周期集成测试 |

### 2. 数据工程师生命周期

**文件**: `tests/e2e/test_engineer_lifecycle.py`

**生命周期阶段**: 登录 → 数据源 → 元数据 → 采集 → ETL

| 测试类 | 测试用例 | 描述 |
|-------|---------|------|
| TestEngineerDataSource | test_list_sources_unauthorized | 未认证列出数据源失败 |
| | test_create_source_validation | 创建数据源参数验证 |
| | test_create_source_success | 成功创建数据源 |
| | test_list_sources_authenticated | 认证后列出数据源 |
| | test_get_source_not_found | 获取不存在数据源 |
| | test_test_source_connection_not_found | 测试不存在数据源连接 |
| TestEngineerMetadata | test_list_tables_unauthorized | 未认证列出元数据表失败 |
| | test_list_tables_authenticated | 认证后列出元数据表 |
| | test_get_table_not_found | 获取不存在的表元数据 |
| | test_scan_source_not_found | 扫描不存在的数据源 |
| TestEngineerCollectTask | test_list_collect_tasks_unauthorized | 未认证列出采集任务失败 |
| | test_list_collect_tasks_authenticated | 认证后列出采集任务 |
| | test_create_collect_task_source_not_found | 创建采集任务数据源不存在 |
| | test_get_collect_task_not_found | 获取不存在采集任务 |
| | test_run_collect_task_not_found | 运行不存在采集任务 |
| TestEngineerETLPipeline | test_list_pipelines_unauthorized | 未认证列出管道失败 |
| | test_list_pipelines_authenticated | 认证后列出管道 |
| | test_create_pipeline_success | 成功创建ETL管道 |
| | test_get_pipeline_not_found | 获取不存在管道 |
| | test_add_step_pipeline_not_found | 添加步骤到不存在管道 |
| | test_preview_pipeline_not_found | 预览不存在管道 |
| | test_run_pipeline_not_found | 运行不存在管道 |
| TestEngineerAISuggestions | test_ai_suggest_rules_unauthorized | 未认证AI建议失败 |
| | test_ai_predict_fill_unauthorized | 未认证AI填充失败 |
| TestEngineerLifecycleIntegration | test_engineer_full_lifecycle | 完整工程师生命周期集成测试 |

### 3. 数据分析师生命周期

**文件**: `tests/e2e/test_analyst_lifecycle.py`

**生命周期阶段**: 登录 → 查询 → 分析 → 资产搜索 → 血缘 → 导出

| 测试类 | 测试用例 | 描述 |
|-------|---------|------|
| TestAnalystNaturalLanguageQuery | test_nl_query_unauthorized | 未认证NL查询失败 |
| | test_nl_query_authenticated | 认证后NL查询 |
| | test_nl_query_invalid_request | 无效请求NL查询 |
| TestAnalystDataQuality | test_data_quality_unauthorized | 未认证数据质量分析失败 |
| | test_data_quality_authenticated | 认证后数据质量分析 |
| TestAnalystAIPrediction | test_ai_predict_unauthorized | 未认证AI预测失败 |
| | test_ai_predict_timeseries | 时序预测测试 |
| | test_ai_predict_clustering | 聚类预测测试 |
| | test_ai_predict_unsupported_model | 不支持模型类型 |
| TestAnalystAssetSearch | test_search_assets_unauthorized | 未认证搜索资产失败 |
| | test_search_assets_authenticated | 认证后搜索资产 |
| | test_search_assets_empty_query | 空查询搜索资产 |
| | test_list_assets_authenticated | 认证后列出资产 |
| TestAnalystLineage | test_view_lineage_unauthorized | 未认证查看血缘失败 |
| | test_view_lineage_not_found | 查看不存在资产血缘 |
| TestAnalystExport | test_export_asset_unauthorized | 未认证导出资产失败 |
| | test_export_asset_not_found | 导出不存在资产 |
| | test_export_asset_formats | 多格式导出测试 |
| TestAnalystLifecycleIntegration | test_analyst_full_lifecycle | 完整分析师生命周期集成测试 |

### 4. 数据资产管理员生命周期

**文件**: `tests/e2e/test_asset_admin_lifecycle.py`

**生命周期阶段**: 登录 → 资产管理 → 认证 → 血缘

| 测试类 | 测试用例 | 描述 |
|-------|---------|------|
| TestAssetAdminAssetCRUD | test_list_assets_unauthorized | 未认证列出资产失败 |
| | test_list_assets_authenticated | 认证后列出资产 |
| | test_list_assets_with_filters | 带过滤条件列出资产 |
| | test_create_asset_success | 成功创建资产 |
| | test_create_asset_invalid_data | 无效数据创建资产 |
| | test_get_asset_not_found | 获取不存在资产 |
| | test_update_asset_not_found | 更新不存在资产 |
| | test_delete_asset_not_found | 删除不存在资产 |
| TestAssetAdminCertification | test_certify_asset_unauthorized | 未认证认证资产失败 |
| | test_certify_asset_not_found | 认证不存在资产 |
| TestAssetAdminLineage | test_get_lineage_unauthorized | 未认证获取血缘失败 |
| | test_get_lineage_not_found | 获取不存在资产血缘 |
| TestAssetAdminSearch | test_search_assets_authenticated | 认证后搜索资产 |
| | test_search_assets_with_tags | 带标签搜索资产 |
| TestAssetAdminExport | test_export_asset_not_found | 导出不存在资产 |
| TestAssetAdminLifecycleIntegration | test_asset_admin_full_lifecycle | 完整资产管理员生命周期 |
| | test_asset_admin_certification_workflow | 资产认证工作流测试 |

### 5. 安全管理员生命周期

**文件**: `tests/e2e/test_security_admin_lifecycle.py`

**生命周期阶段**: 登录 → 敏感检测 → 告警管理

| 测试类 | 测试用例 | 描述 |
|-------|---------|------|
| TestSecurityAdminSensitiveDetection | test_detect_sensitive_unauthorized | 未认证敏感检测失败 |
| | test_detect_sensitive_source_not_found | 检测不存在数据源 |
| TestSecurityAdminAlertRules | test_list_alert_rules_unauthorized | 未认证列出规则失败 |
| | test_list_alert_rules_authenticated | 认证后列出规则 |
| | test_create_alert_rule_success | 成功创建告警规则 |
| | test_create_alert_rule_invalid_data | 无效数据创建规则 |
| | test_update_alert_rule_not_found | 更新不存在规则 |
| | test_delete_alert_rule_not_found | 删除不存在规则 |
| TestSecurityAdminAlerts | test_list_alerts_unauthorized | 未认证列出告警失败 |
| | test_list_alerts_authenticated | 认证后列出告警 |
| | test_list_alerts_with_status_filter | 带状态过滤列出告警 |
| | test_acknowledge_alert_not_found | 确认不存在告警 |
| | test_resolve_alert_not_found | 解决不存在告警 |
| TestSecurityAdminLifecycleIntegration | test_security_admin_full_lifecycle | 完整安全管理员生命周期 |
| | test_security_admin_alert_workflow | 告警处理工作流测试 |
| | test_security_admin_rule_lifecycle | 规则CRUD生命周期测试 |

## 功能覆盖矩阵

| 功能模块 | 管理员 | 工程师 | 分析师 | 资产管理 | 安全管理 |
|---------|--------|--------|--------|---------|---------|
| 登录/注册 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 用户管理 | ✓ | - | - | - | - |
| 角色管理 | ✓ | - | - | - | - |
| 数据源CRUD | - | ✓ | - | - | - |
| 元数据扫描 | - | ✓ | - | - | - |
| 采集任务 | - | ✓ | - | - | - |
| ETL管道 | - | ✓ | - | - | - |
| 自然语言查询 | - | - | ✓ | - | - |
| AI预测 | - | - | ✓ | - | - |
| 数据质量分析 | - | - | ✓ | - | - |
| 资产CRUD | - | - | - | ✓ | - |
| 资产认证 | - | - | - | ✓ | - |
| 资产搜索 | - | - | ✓ | ✓ | - |
| 血缘追溯 | - | - | ✓ | ✓ | - |
| 资产导出 | - | - | ✓ | ✓ | - |
| 敏感检测 | - | - | - | - | ✓ |
| 告警规则管理 | - | - | - | - | ✓ |
| 告警处理 | - | - | - | - | ✓ |
| 审计日志 | ✓ | - | - | - | - |

**API 覆盖率**: 全部 49 个 API 端点均被覆盖

## 运行测试

### 运行所有 E2E 测试

```bash
cd backend
pytest tests/e2e/ -v
```

### 运行特定角色测试

```bash
# 管理员测试
pytest tests/e2e/test_admin_lifecycle.py -v

# 工程师测试
pytest tests/e2e/test_engineer_lifecycle.py -v

# 分析师测试
pytest tests/e2e/test_analyst_lifecycle.py -v

# 资产管理员测试
pytest tests/e2e/test_asset_admin_lifecycle.py -v

# 安全管理员测试
pytest tests/e2e/test_security_admin_lifecycle.py -v
```

### 生成覆盖率报告

```bash
pytest tests/e2e/ --cov=app --cov-report=html
```

### 运行特定测试类

```bash
pytest tests/e2e/test_admin_lifecycle.py::TestAdminRoleManagement -v
```

## Fixtures 说明

### 用户 Fixtures

| Fixture | 描述 |
|---------|------|
| `superuser_data` | 超级管理员测试数据 |
| `superuser_headers` | 超级管理员认证头 |
| `superuser_mock` | 超级管理员 Mock 对象 |
| `data_engineer_data` | 数据工程师测试数据 |
| `data_engineer_headers` | 数据工程师认证头 |
| `data_engineer_mock` | 数据工程师 Mock 对象 |
| `data_analyst_data` | 数据分析师测试数据 |
| `data_analyst_headers` | 数据分析师认证头 |
| `data_analyst_mock` | 数据分析师 Mock 对象 |
| `asset_admin_data` | 资产管理员测试数据 |
| `asset_admin_headers` | 资产管理员认证头 |
| `asset_admin_mock` | 资产管理员 Mock 对象 |
| `security_admin_data` | 安全管理员测试数据 |
| `security_admin_headers` | 安全管理员认证头 |
| `security_admin_mock` | 安全管理员 Mock 对象 |

### 配置 Fixtures

| Fixture | 描述 |
|---------|------|
| `sample_data_source_config` | 数据源配置示例 |
| `sample_etl_pipeline_config` | ETL 管道配置示例 |
| `sample_alert_rule_config` | 告警规则配置示例 |
| `sample_asset_config` | 数据资产配置示例 |

## 测试设计原则

1. **不可变数据**: 所有测试数据使用 `dataclass(frozen=True)` 确保不可变
2. **独立性**: 每个测试用例独立运行，不依赖其他测试结果
3. **幂等性**: 测试可重复运行，结果一致
4. **完整覆盖**: 覆盖正常流程和异常流程
5. **角色隔离**: 每个角色的测试验证权限边界

## 更新日志

| 日期 | 版本 | 描述 |
|------|------|------|
| 2026-02-16 | 1.0.0 | 初始版本，实现五种角色生命周期测试 |
