# è°ƒåº¦å™¨ç³»ç»Ÿè¿ç§»è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-02-19
**çŠ¶æ€**: ğŸ“ è®¡åˆ’ä¸­ (Phase 4)

## å½“å‰çŠ¶æ€

é¡¹ç›®åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªè°ƒåº¦ç³»ç»Ÿï¼š

| è°ƒåº¦å™¨ | ç”¨é€” | æ–‡ä»¶ | çŠ¶æ€ |
|--------|------|------|------|
| APScheduler | æ•°æ®é‡‡é›†ä»»åŠ¡è°ƒåº¦ | `core/scheduler.py`, `services/scheduler_service.py` | âœ… ä½¿ç”¨ä¸­ |
| Celery | åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ— | `docker-compose.ops.yml` (Worker + Beat) | âš ï¸ é…ç½®ä½†æœªä½¿ç”¨ |

## è¿ç§»æ–¹æ¡ˆ

### ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend API                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Collect Tasks â”‚  â”‚ Report Tasks  â”‚  â”‚  ETL Tasks   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Celery Beat     â”‚
                    â”‚  (Scheduler)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Redis (Broker)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Celery Worker â”‚   â”‚ Celery Worker 2 â”‚   â”‚ Celery Worker â”‚
â”‚  (default)    â”‚   â”‚  (heavy tasks)  â”‚   â”‚    (backup)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿ç§»æ­¥éª¤

#### Phase 1: åˆ›å»º Celery Worker æ¨¡å—

1. åˆ›å»º `app/celery_worker.py`
   ```python
   from celery import Celery
   from app.core.config import settings

   celery_app = Celery(
       "smart_data_platform",
       broker=settings.CELERY_BROKER_URL,
       backend=settings.CELERY_RESULT_BACKEND,
   )

   # æ³¨å†Œä»»åŠ¡
   from app.tasks import collect_tasks, report_tasks, etl_tasks
   ```

2. åˆ›å»º `app/tasks/` ç›®å½•
   - `__init__.py`
   - `collect_tasks.py` - æ•°æ®é‡‡é›†ä»»åŠ¡
   - `report_tasks.py` - æŠ¥è¡¨ç”Ÿæˆä»»åŠ¡
   - `etl_tasks.py` - ETL æ‰§è¡Œä»»åŠ¡

#### Phase 2: è¿ç§»é‡‡é›†ä»»åŠ¡

å°† `scheduler_service.py` ä¸­çš„ APScheduler ä»»åŠ¡è¿ç§»åˆ° Celery:

```python
# app/tasks/collect_tasks.py
from app.celery_worker import celery_app

@celery_app.task(name="collect.execute_task")
def execute_collect_task(task_id: str):
    """æ‰§è¡Œæ•°æ®é‡‡é›†ä»»åŠ¡"""
    # å®ç°ä» scheduler_service.py:execute_collect_task è¿ç§»
    ...
```

#### Phase 3: è¿ç§»æŠ¥è¡¨ä»»åŠ¡

å°† `report_service.py` ä¸­çš„å®šæ—¶æŠ¥è¡¨è¿ç§»åˆ° Celery Beat:

```python
# app/tasks/report_tasks.py
from app.celery_worker import celery_app

@celery_app.task(name="report.generate_scheduled")
def generate_scheduled_report(schedule_id: str):
    """ç”Ÿæˆå®šæ—¶æŠ¥è¡¨"""
    ...
```

#### Phase 4: æ›´æ–° API å±‚

ä¿®æ”¹ `scheduler_service.py` ä½¿ç”¨ Celery è€Œé APScheduler:

```python
# ä½¿ç”¨ Celery Beat è°ƒåº¦
from app.tasks.collect_tasks import execute_collect_task

# è°ƒåº¦ä»»åŠ¡
result = execute_collect_task.apply_async(
    args=[str(task_id)],
    countdown=countdown,
)
```

#### Phase 5: ç§»é™¤ APScheduler

1. ç§»é™¤ `apscheduler==3.10.4` ä¾èµ–
2. åˆ é™¤ `core/scheduler.py`
3. æ›´æ–° Docker Compose ç¡®ä¿ Celery Beat å¯åŠ¨

## å®æ–½ä¼˜å…ˆçº§

| æ­¥éª¤ | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|------|------|--------|------------|
| 1 | åˆ›å»º Celery Worker æ¨¡å— | é«˜ | 2å°æ—¶ |
| 2 | è¿ç§»é‡‡é›†ä»»åŠ¡ | é«˜ | 3å°æ—¶ |
| 3 | è¿ç§»æŠ¥è¡¨ä»»åŠ¡ | ä¸­ | 2å°æ—¶ |
| 4 | æ›´æ–° API å±‚ | é«˜ | 2å°æ—¶ |
| 5 | ç§»é™¤ APScheduler | ä½ | 1å°æ—¶ |

**æ€»è®¡**: çº¦ 10 å°æ—¶

## æ”¶ç›Š

1. **åˆ†å¸ƒå¼å¤„ç†**: æ”¯æŒå¤š Worker æ‰©å±•
2. **ä»»åŠ¡æŒä¹…åŒ–**: ä»»åŠ¡çŠ¶æ€ä¿å­˜åœ¨ Redis
3. **ä»»åŠ¡é‡è¯•**: å†…ç½®é‡è¯•æœºåˆ¶
4. **ä»»åŠ¡ç›‘æ§**: Flower ç›‘æ§ç•Œé¢æ”¯æŒ
5. **ç»Ÿä¸€è°ƒåº¦**: æ‰€æœ‰å®šæ—¶ä»»åŠ¡ä½¿ç”¨ Celery Beat

## é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| ä»»åŠ¡æ‰§è¡Œå·®å¼‚ | å……åˆ†æµ‹è¯•åå†åˆ‡æ¢ |
| ç°æœ‰ä»»åŠ¡ä¸­æ–­ | ä½¿ç”¨ç°åº¦å‘å¸ƒ |
| é…ç½®å¤æ‚åº¦ | æä¾›è¯¦ç»†æ–‡æ¡£ |

## å‚è€ƒèµ„æ–™

- Celery æ–‡æ¡£: https://docs.celeryq.dev/
- Celery Beat é…ç½®: https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html
